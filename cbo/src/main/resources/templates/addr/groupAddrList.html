<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layouts/mainLayout">
<head>

<script>
function showAddGroupInput() {
    document.getElementById('addGroupForm').style.display = 'block';
    document.getElementById('groupNameInput').focus();
}
function hideAddGroupInput() {
    document.getElementById('addGroupForm').style.display = 'none';
    document.getElementById('groupNameInput').value = '';
}
function validateGroupInput() {
    var input = document.getElementById('groupNameInput').value.trim();
    if(input === "") {
        alert("그룹명을 입력하세요.");
        return false;
    }
    return true;
}

function addGroupFetch() {
    const groupName = document.getElementById('groupNameInput').value.trim();
    if (!groupName) {
        alert("그룹명을 입력하세요.");
        return;
    }

    fetch('/addr/addGroup', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ groupName: groupName })
    })
    .then(response => res => res.json())
    .then(data => {
    	const groupList = document.querySelector('.sidebar-group-list');
    	const newDiv = document.createElement('div');
    	const newA = document.createElement('a');
    	const newSpan = document.createElement('span');

    	newA.textContent = groupName; // 그룹명
    	newA.href = '/groupAddrList/' + encodeURIComponent(groupName);
    	newA.className = 'sidebar-link';
    	newA.style = 'text-decoration:none; color:black;';

    	newSpan.className = 'sidebar-contact-count';
    	newSpan.textContent = data.countUser !== undefined ? data.countUser : 0;
    	newDiv.appendChild(newA);
    	newDiv.appendChild(newSpan);
    	groupList.appendChild(newDiv);

        hideAddGroupInput();
    });
}

function toggleQuickForm() {
    const form = document.getElementById('quickForm');
    form.style.display = (form.style.display === 'none' || form.style.display === '') ? 'block' : 'none';
}
function submitQuickForm() {
    var form = document.getElementById('quickGroupAddForm');
    var formData = new FormData(form);
    fetch('/quickGroupAddrAdd', {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(result => {
        document.getElementById('quickForm').style.display = 'none';
        window.location.reload();

        // 성공 시 폼 초기화 등 추가
    })
}



//전체 선택/해제 기능
function check() {
 const checkAll = document.getElementById('checkAll');
 const checkboxes = document.querySelectorAll('.user-check');
 checkboxes.forEach(cb => cb.checked = checkAll.checked);
}

//삭제 기능 (체크된 것만)
function deleteChecked() {
 const checked = document.querySelectorAll('.user-check:checked');
 const ids = Array.from(checked).map(cb => cb.value);

 if (ids.length === 0) {
     alert('삭제할 항목을 선택하세요.');
     return;
 }

 fetch('/addr/delete', {
     method: 'POST',
     headers: {
         'Content-Type': 'application/json'
     },
     body: JSON.stringify({ ids: ids })
 })
 .then(res => res.json())
 .then(result => {
     window.location.reload();
 })
 .catch(err => {
     alert('삭제 중 오류가 발생했습니다.');
 });
}
</script>
<meta charset="UTF-8">
<title>주소록 관리</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
    .sidebar-section-title {
        font-weight: bold;
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
    }
    .sidebar-section-title i {
        font-size: 1rem;
        margin-left: 4px;
        color: #aaa;
        cursor: pointer;
    }
    .sidebar-link {
        color: #222 !important;
        text-decoration: none;
        font-weight: 500;
        margin-bottom: 0.25rem;
        display: inline-block;
        font-size: 0.95rem;
    }
    .sidebar-group-list {
        margin-left: 1.2rem;
        margin-bottom: 0.5rem;
    }
    .sidebar-add-btn {
        color: #222 !important;
        cursor: pointer;
        font-size: 0.95rem;
        margin-top: 0.5rem;
        display: inline-block;
        font-weight: 500;
    }
    .sidebar-contact-count {
        color: #0096e2;
        font-weight: bold;
        margin-left: 0.5rem;
        font-size: 0.95rem;
    }
    .sidebar-group-name {
        font-size: 0.97rem;
        margin-bottom: 0.2rem;
    }
    .sidebar-section {
        margin-bottom: 2rem;
    }
    .sidebar-divider {
        border-top: 1px solid #eee;
        margin: 1.5rem 0 1rem 0;
    }
    .sidebar-disabled-input {
        background: #f3f3f3;
        border: 1px solid #e0e0e0;
        color: #aaa;
        font-size: 0.95rem;
        padding: 2px 8px;
        border-radius: 4px;
        margin-bottom: 0.5rem;
        width: 90%;
    }
</style>
</head>
<body>
<div layout:fragment="content">
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-2 d-none d-md-block bg-light sidebar" style="min-height:100vh;">
                <div class="sidebar-sticky pt-4">
                    <!-- 개인 주소록 -->
                    <div class="sidebar-section">
                    <button class="btn btn-outline-primary w-100 mb-3" onclick="location.href='/goInsertPage'">
					    연락처 추가
					</button>
                        <div class="sidebar-section-title">
                            <span data-bs-toggle="collapse" href="#personalCollapse" role="button" aria-expanded="true" aria-controls="personalCollapse" style="cursor:pointer;">
                                개인 주소록
                            </span>
                            <i class="bi bi-gear ms-auto"></i>
                        </div>
                        <div class="collapse show" id="personalCollapse">
                            <a href="/addrMain" class="sidebar-link">전체 주소록</a>
                            
                            <div class="sidebar-group-list">
                                <!-- 그룹명 반복 출력 -->
                                <div th:each="group : ${personalLists}">
                                    <a th:href="@{'/groupAddrList/' + ${group.name}}" th:text="${group.name}" style="text-decoration:none; color:black;"></a>
                                    <span class="sidebar-contact-count" th:text="${groupUserCountMap[group.name]}" >0</span>
                                </div>
                            </div>
                            <div class="sidebar-group-list">
                            </div>
                            <div id="addGroupForm" style="display:none;">
							    <input type="text" class="form-control form-control-sm" name = "groupName" id="groupNameInput" placeholder="그룹명을 입력하세요">
							    <button type="button" class="btn btn-primary btn-sm mt-2" onclick="addGroupFetch()">확인</button>
							    <button type="button" class="btn btn-secondary btn-sm mt-2" onclick="hideAddGroupInput()">취소</button>
							</div>
                            <div class="sidebar-add-btn" onclick="showAddGroupInput()">+ 개인 주소록 추가</div>
                            
                            
                        </div>
                    </div>
                    <div class="sidebar-divider"></div>
                    <!-- 부서 주소록 -->
                    <div class="sidebar-section">
                        <div class="sidebar-section-title">
                            <span data-bs-toggle="collapse" href="#deptCollapse" role="button" aria-expanded="true" aria-controls="deptCollapse" style="cursor:pointer;">
                                부서 주소록
                            </span>
                        </div>
                        <div class="collapse show" id="deptCollapse">
                        <div class="sidebar-group-name" th:text="${dept}"></div>
                            <div class="sidebar-group-list">
                                <!-- 부서 그룹 반복 -->
                                    <a href="/deptAddr" class="sidebar-link" style="display:inline-block;">전체 주소록</a>
                                	<div th:each="dept : ${deptLists}">
                                            <span th:text="${dept.name}">안녕</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>
            <!-- Main content -->
            <div class="col-md-10 ms-sm-auto px-4">
                <!-- 직원 내용 테이블 -->
                <div class="mb-3" style="border-bottom:1px solid #eee; padding-bottom:12px;">
    <div>
        <span style="font-size:2rem; font-weight:600;" th:text=${groupName}>전체 주소록</span>
        <span style="color:#888; font-size:1rem; margin-left:8px;">
            in개인주소록
            <span th:text="'(총 ' + ${countUser} + '건)'">(총 25건)</span>
        </span>
    </div>
    <div class="mt-2">
        <button type="button" class="btn btn-link px-2" style="font-weight:500; color:#222;" onclick="toggleQuickForm()">
   			 <i class="bi bi-plus-lg"></i> 빠른 등록
		</button>
       <!--  <button type="button" class="btn btn-link px-2" style="font-weight:500; color:#222;">
            <i class="bi bi-people"></i> 그룹지정
        </button> -->
        <button type="button" class="btn btn-link px-2" style="font-weight:500; color:#222;" onclick="deleteChecked();">
            <i class="bi bi-trash"></i> 삭제
            </button>
     <div style="display:none; margin-top:12px;" id = "quickForm">
    <form class="d-flex align-items-center gap-2" id="quickGroupAddForm">
    	<input type="hidden" name="groupId" th:value="${groupId}">
        <input type="text" class="form-control" style="max-width:160px;" placeholder="이름(표시명)" name="nickname" required>
        <input type="email" class="form-control" style="max-width:180px;" placeholder="이메일" name="email" required>
        <input type="tel" class="form-control" style="max-width:140px;" placeholder="휴대폰" name="tel" required>
        <button type="button" class="btn btn-outline-primary" onclick="submitQuickForm();">+</button>
       <!-- <button type="button" class="btn btn-link" style="color:#666;" onclick="alert('상세정보 폼 구현 필요!')">상세정보 추가</button> -->
    </form>
		</div>
    </div>
</div>
                
                 <form id="checkForm">
        <table class="table table-hover mt-4">
            <thead>
                <tr>
                    <th scope="col">
                        <input type="checkbox" class="checkAll" id="checkAll" onclick="check();">
                    </th>
                    <th scope="col">이름(표시명)</th>
                    <th scope="col">휴대폰</th>
                    <th scope="col">이메일</th>
                    <th scope="col">회사</th>
                    <th scope="col">회사전화</th>
                    <th scope="col">그룹</th>
                </tr>
            </thead>
            <tbody id="datarows">
                <tr th:if="${#lists.isEmpty(groupAddrLists)}">
                    <td colspan="8" align="center">등록된 사원이 없습니다</td>
                </tr>
                <tr th:each="dto:${groupAddrLists}">
                    <td>
                        <input type="checkbox" class="user-check" th:value="${dto.id}" th:name="ids" th:id="${dto.id}">
                    </td>
                    <td th:text="${dto.nickname}"></td>
                    <td th:text="${dto.tel}"></td>
                    <td th:text="${dto.email}"></td>
                    <td th:text="${dto.company}"></td>
                    <td th:text="${dto.companytel}"></td>
                    <td th:text="${dto.groupNames}"></td>
                    <td></td>
                </tr>
            </tbody>
        </table>
    </form>
            </div>
        </div>
    </div>
</div>


</body>
</html>
