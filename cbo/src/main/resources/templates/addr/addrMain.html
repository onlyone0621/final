<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layouts/mainLayout">
<head>

<script>
function showAddGroupInput() {
    document.getElementById('addGroupForm').style.display = 'block';
    document.getElementById('groupNameInput').focus();
}
function hideAddGroupInput() {
    document.getElementById('addGroupForm').style.display = 'none';
    document.getElementById('groupNameInput').value = '';
}

//부서 주소록 연락처 등록
function showAddDeptGroupInput() {
    document.getElementById('addDeptGroupForm').style.display = 'block';
    document.getElementById('deptGroupNameInput').focus();
}
function hideAddDeptGroupInput() {
    document.getElementById('addDeptGroupForm').style.display = 'none';
    document.getElementById('deptGroupNameInput').value = '';
}

function validateGroupInput() {
    var input = document.getElementById('groupNameInput').value.trim();
    if(input === "") {
        alert("그룹명을 입력하세요.");
        return false;
    }
    return true;
}

function addGroupFetch() {
    const groupName = document.getElementById('groupNameInput').value.trim();
    if (!groupName) {
        alert("그룹명을 입력하세요.");
        return;
    }

    fetch('/addr/addGroup', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ groupName: groupName })
    })
    .then(response => res => res.json())
    .then(data => {
        const groupList = document.querySelector('.sidebar-group-list');
        const newDiv = document.createElement('div');
        newDiv.textContent = groupName;
        groupList.appendChild(newDiv);

        hideAddGroupInput();
    });
}

function toggleQuickForm() {
    const form = document.getElementById('quickForm');
    form.style.display = (form.style.display === 'none' || form.style.display === '') ? 'block' : 'none';
}

function submitQuickForm() {
    var form = document.getElementById('quickAddForm');
    var formData = new FormData(form);
    fetch('quickAddrAdd', {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(result => {
        document.getElementById('quickForm').style.display = 'none';
        window.location.reload();

        // 성공 시 폼 초기화 등 추가
    })
}

function deleteChecked() {
    // 체크된 체크박스만 선택
    const checked = document.querySelectorAll('.user-check:checked');
    // 체크된 값(id)만 배열로 추출
    const ids = Array.from(checked).map(cb => cb.value);

    if (ids.length === 0) {
        alert('삭제할 항목을 선택하세요.');
        return;
    }

    // Ajax로 서버에 삭제 요청 (JSON 방식 예시)
    fetch('/addr/delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ ids: ids })
    })
    .then(res => res.json())
    .then(result => {
        // 성공 시 새로고침 또는 목록 갱신
        window.location.reload();
    })
    .catch(err => {
        alert('삭제 중 오류가 발생했습니다.');
    });
}

function openGroupAssignModal() {
    const checked = document.querySelectorAll('.user-check:checked');
    document.getElementById('selectedCount').innerText = checked.length;
    document.getElementById('newGroupSelect').value = '';
    document.getElementById('groupAssignAlert').classList.add('d-none');
}

// 그룹 지정 확인 버튼
function assignGroupToChecked() {
    const checked = document.querySelectorAll('.user-check:checked');
    const ids = Array.from(checked).map(cb => cb.value);
    const groupId = document.getElementById('newGroupSelect').value;
    console.log('groupId:', groupId); 

    if (ids.length === 0) {
        alert('그룹을 지정할 연락처를 먼저 선택하세요.');
        return;
    }
    if (!groupId) {
        document.getElementById('groupAssignAlert').classList.remove('d-none');
        return;
    }

    // 서버에 그룹 지정 요청 (여기서는 예시로 POST /addr/assignGroup 사용)
    fetch('/addr/assignGroup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: ids, groupId: groupId })
    })
    .then(res => res.json())
    .then(result => {
        if (result === 1) {
            // 성공
            
            location.reload();
        } 
    })
    .catch(() => alert('서버 오류가 발생했습니다.'));
}

// 그룹 삭제 및 이름 바꾸기
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('deleteGroupBtn').onclick = function() {
        const groupId = document.getElementById('groupSelect').value;
        if (!groupId) {
            alert('삭제할 그룹을 선택하세요.');
            return;
        }
        if (!confirm('정말로 이 그룹을 삭제하시겠습니까?')) return;
        fetch('/addr/deleteGroup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ groupId: groupId })
        })
        .then(res => res.json())
        .then(result => {
            if (result === 1) {
                location.reload();
            } else {
                alert('삭제에 실패했습니다.');
            }
        })
        .catch(() => alert('서버 오류가 발생했습니다.'));
    };


document.getElementById('renameGroupBtn').onclick = function() {
    const groupId = document.getElementById('groupSelect').value;
    const newName = document.getElementById('newGroupName').value.trim();
    if (!groupId) {
        alert('변경할 그룹을 선택하세요.');
        return;
    }
    if (!newName) {
        alert('새 그룹명을 입력하세요.');
        return;
    }
    if (!confirm('정말로 그룹명을 변경하시겠습니까?')) return;
    fetch('/addr/renameGroup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ groupId: groupId, newGroupName: newName })
    })
    .then(res => res.json())
    .then(result => {
        if (result === 1) {
            alert('그룹명이 변경되었습니다.');
            location.reload();
        } else {
            alert('변경에 실패했습니다.');
        }
    })
    .catch(() => alert('서버 오류가 발생했습니다.'));
};
});

// 실제 부서 그룹 추가 fetch (예시, 엔드포인트는 상황에 맞게)
function addDeptGroupFetch() {
    const groupName = document.getElementById('deptGroupNameInput').value.trim();
    if (!groupName) {
        alert("그룹명을 입력하세요.");
        return;
    }

    fetch('/addr/addDeptGroup', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ GroupName: groupName })
    })
    .then(res => res.json())
    .then(data => {
        const groupList = document.querySelector('.sidebar-group-list');
        const newDiv = document.createElement('div');
        newDiv.textContent = groupName;
        groupList.appendChild(newDiv);

        hideAddGroupInput();
    });
}
</script>
<meta charset="UTF-8">
<title>주소록 관리</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
    .sidebar-section-title {
        font-weight: bold;
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
    }
    .sidebar-section-title i {
        font-size: 1rem;
        margin-left: 4px;
        color: #aaa;
        cursor: pointer;
    }
    .sidebar-link {
        color: #222 !important;
        text-decoration: none;
        font-weight: 500;
        margin-bottom: 0.25rem;
        display: inline-block;
        font-size: 0.95rem;
    }
    .sidebar-group-list {
        margin-left: 1.2rem;
        margin-bottom: 0.5rem;
    }
    .sidebar-add-btn {
        color: #222 !important;
        cursor: pointer;
        font-size: 0.95rem;
        margin-top: 0.5rem;
        display: inline-block;
        font-weight: 500;
    }
    .sidebar-contact-count {
        color: #0096e2;
        font-weight: bold;
        margin-left: 0.5rem;
        font-size: 0.95rem;
    }
    .sidebar-group-name {
        font-size: 0.97rem;
        margin-bottom: 0.2rem;
    }
    .sidebar-section {
        margin-bottom: 2rem;
    }
    .sidebar-divider {
        border-top: 1px solid #eee;
        margin: 1.5rem 0 1rem 0;
    }
    .sidebar-disabled-input {
        background: #f3f3f3;
        border: 1px solid #e0e0e0;
        color: #aaa;
        font-size: 0.95rem;
        padding: 2px 8px;
        border-radius: 4px;
        margin-bottom: 0.5rem;
        width: 90%;
    }
</style>
</head>
<body>
<div layout:fragment="content">
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-2 d-none d-md-block bg-light sidebar" style="min-height:100vh;">
                <div class="sidebar-sticky pt-4">
                    <!-- 개인 주소록 -->
                    <div class="sidebar-section">
                    <button class="btn btn-outline-primary w-100 mb-3" onclick="location.href='/goInsertPage'">
					    연락처 추가
					</button>
                        <div class="sidebar-section-title">
						    <span data-bs-toggle="collapse" href="#personalCollapse" role="button" aria-expanded="true" aria-controls="personalCollapse" style="cursor:pointer;">
						        개인 주소록
						    </span>
						    <i class="bi bi-gear ms-auto"
						       style="cursor:pointer;"
						       data-bs-toggle="modal"
						       data-bs-target="#groupManageModal"></i>
						</div>
						
							<!-- 그룹관리 모달 -->
						<div class="modal fade" id="groupManageModal" tabindex="-1" aria-labelledby="groupManageModalLabel" aria-hidden="true">
						  <div class="modal-dialog">
						    <div class="modal-content">
						      <div class="modal-header">
						        <h5 class="modal-title" id="groupManageModalLabel">그룹관리</h5>
						        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
						      </div>
						      <div class="modal-body">
						        <div class="mb-3">
						          <label for="groupSelect" class="form-label">그룹선택</label>
						          <select class="form-select" id="groupSelect" name = "groupId">
						            <option value="">그룹을 선택하세요</option>
						            <option th:each="group : ${personalLists}" th:value="${group.id}" th:text="${group.name}"></option>
						          </select>
						        </div>
						        <div class="mb-3">
						          <label for="newGroupName" class="form-label">새 이름</label>
						          <input type="text" class="form-control" id="newGroupName" placeholder="새 그룹명 입력">
						        </div>
						      </div>
						      <div class="modal-footer">
						        <button type="button" class="btn btn-primary" id="renameGroupBtn">그룹이름 변경</button>
						        <button type="button" class="btn btn-danger" id="deleteGroupBtn">그룹삭제</button>
						        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
						      </div>
						    </div>
						  </div>
						</div>

						
                        <div class="collapse show" id="personalCollapse">
                            <a href="addrMain" class="sidebar-link">전체 주소록</a>
                            
                            <div class="sidebar-group-list">
                                <!-- 그룹명 반복 출력 -->
                                <div th:each="group : ${personalLists}">
								    <a th:href="@{'/groupAddrList/' + ${group.name}}" th:text="${group.name}" style="text-decoration:none; color:black;"></a>
								    <span class="sidebar-contact-count" th:text="${groupUserCountMap[group.name]}">0</span>
								</div>
                            </div>
                            <div class="sidebar-group-list">
                            </div>
                            <div id="addGroupForm" style="display:none;">
							    <input type="text" class="form-control form-control-sm" name = "groupName" id="groupNameInput" placeholder="그룹명을 입력하세요">
							    <button type="button" class="btn btn-primary btn-sm mt-2" onclick="addGroupFetch()">확인</button>
							    <button type="button" class="btn btn-secondary btn-sm mt-2" onclick="hideAddGroupInput()">취소</button>
							</div>
                            <div class="sidebar-add-btn" onclick="showAddGroupInput()">+ 개인 주소록 추가</div>
                            
                            
                        </div>
                    </div>
                    <div class="sidebar-divider"></div>
                    <!-- 부서 주소록 -->
                    <div class="sidebar-section">
                        <div class="sidebar-section-title">
                            <span data-bs-toggle="collapse" href="#deptCollapse" role="button" aria-expanded="true" aria-controls="deptCollapse" style="cursor:pointer;">
                                부서 주소록
                            </span>
                        </div>
                        <div class="collapse show" id="deptCollapse">
                        <div class="sidebar-group-name" th:text="${dept}"></div>
                            <div class="sidebar-group-list">
                            <a href="deptAddr" class="sidebar-link" style="display:inline-block;">전체 주소록</a>
                                	<div th:each="dept : ${deptLists}">
                                            <span th:text="${dept.name}">안녕</span>
                                </div>
                                </div>
							    <!-- 부서 주소록 추가 입력창 (처음엔 숨김) -->
							    <div id="addDeptGroupForm" style="display:none;">
							        <input type="text" class="form-control form-control-sm" name="deptGroupName" id="deptGroupNameInput" placeholder="부서 그룹명을 입력하세요">
							        <button type="button" class="btn btn-primary btn-sm mt-2" onclick="addDeptGroupFetch()">확인</button>
							        <button type="button" class="btn btn-secondary btn-sm mt-2" onclick="hideAddDeptGroupInput()">취소</button>
							    </div>
							
							<!-- 부서 주소록 추가 버튼 -->
                        </div>
                    </div>
                </div>
            </nav>
            <!-- Main content -->
            <div class="col-md-10 ms-sm-auto px-4">
                <div class="mb-3" style="border-bottom:1px solid #eee; padding-bottom:12px;">
    <div>
        <span style="font-size:2rem; font-weight:600;" >전체 주소록</span>
        <span style="color:#888; font-size:1rem; margin-left:8px;">
            in개인주소록
            <span th:text="'(총 ' + ${countAllUser} + '건)'">(총 25건)</span>
        </span>
    </div>
    <div class="mt-2">
        <button type="button" class="btn btn-link px-2" style="font-weight:500; color:#222;" onclick="toggleQuickForm();">
    <i class="bi bi-plus-lg"></i> 빠른 등록
</button>

        <button type="button" class="btn btn-link px-2" style="font-weight:500; color:#222;"
        data-bs-toggle="modal" data-bs-target="#groupAssignModal"
        onclick="openGroupAssignModal();">
  		 <i class="bi bi-people"></i> 그룹지정
		</button>
		<div class="modal fade" id="groupAssignModal" tabindex="-1" aria-labelledby="groupAssignModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="groupAssignModalLabel">그룹 지정</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body">
        <div id="groupAssignAlert" class="alert alert-warning d-none" role="alert">
          그룹을 선택하세요.
        </div>
        <div class="mb-3">
          <label for="newGroupSelect" class="form-label">그룹 선택</label>
         <select class="form-select" id="newGroupSelect" name="groupId">
            <option value="">-- 그룹을 선택하세요 --</option>
            <option th:each="group : ${personalLists}" th:value="${group.id}" th:text="${group.name}"></option>
          </select>
        </div>
        <div>
          <span>선택된 연락처: </span>
          <span id="selectedCount" style="font-weight:bold;">0</span>명
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
        <button type="button" class="btn btn-primary" onclick="assignGroupToChecked()">확인</button>
      </div>
    </div>
  </div>
</div>

        <button type="button" class="btn btn-link px-2" id = "delete" style="font-weight:500; color:#222;" onclick="deleteChecked();">
            <i class="bi bi-trash"></i> 삭제
        </button>
        
        <div id="quickForm" style="display:none; margin-top:12px;">
    <form class="d-flex align-items-center gap-2" id = "quickAddForm">
        <input type="text" class="form-control" style="max-width:160px;" placeholder="이름(표시명)" name="nickname" required>
        <input type="email" class="form-control" style="max-width:180px;" placeholder="이메일" name="email" required>
        <input type="tel" class="form-control" style="max-width:140px;" placeholder="휴대폰" name="tel" required>
        <button type="button" class="btn btn-outline-primary" onclick="submitQuickForm();">+</button>
        <!-- <button type="button" class="btn btn-link" style="color:#666;" onclick="alert('상세정보 폼 구현 필요!')">상세정보 추가</button> -->
    </form>
</div>
    </div>
</div>
<script>
var swvalue = true;
function show() {
    var datarows = document.getElementById("datarows");
    var checkList = datarows.getElementsByTagName("input");
    for (var i = 0; i < checkList.length; i++) {
        checkList[i].checked = swvalue;
    }
    swvalue = !swvalue;
}


</script>
				<form id ="checkForm">
                <table class="table table-hover mt-4">
                    <thead>
                        <tr>
                            <th scope="col"><input type = "checkbox" class="checkAll" id = "checkAll"  onclick="show()"></th>
                            <th scope="col">이름(표시명)</th>
                            <th scope="col">휴대폰</th>
                            <th scope="col">이메일</th>
                            <th scope="col">회사</th>
                            <th scope="col">회사전화</th>
                            <th scope="col">그룹</th>
                        </tr>
                    </thead>
                    <tbody id="datarows">
                        <tr th:if="${#lists.isEmpty(addrLists)}">
                            <td colspan="7" align="center">등록된 사원이 없습니다</td>
                        </tr>
                        
                        <tr th:each="dto:${addrLists}" >
                            <td><input type = "checkbox" class = "user-check" th:value = "${dto.id}" th:name = "${dto.id}" th:id="${dto.id}"></td>
                            <td>
							  <a th:href="@{/addrModifyPage(id=${dto.id})}" th:text="${dto.nickname}" style="cursor:pointer; color:inherit; text-decoration:none;"></a>
							</td>
                            <td th:text="${dto.tel}"></td>
                            <td th:text="${dto.email}"></td>
                            <td th:text="${dto.company}"></td>
                            <td th:text="${dto.companytel}"></td>
                            <td th:text="${dto.groupNames}"></td>
                        </tr>
                        
                    </tbody>
                </table>
                </form>
            </div>
        </div>
    </div>
</div>

</body>
</html>
