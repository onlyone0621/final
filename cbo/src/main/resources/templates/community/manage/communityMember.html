<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layouts/mainLayout">
<head>
    <meta charset="UTF-8">
    <title>ë©¤ë²„ ê´€ë¦¬</title>
    <style>
        .container { display: flex; min-height: 100vh; }
        .sidebar { width: 220px; background-color: #fbf9fd; padding: 20px; border-right: 1px solid #ddd; }
        .main { flex: 1; padding: 20px; }
        .tabs { border-bottom: 1px solid #ddd; margin-bottom: 20px; }
        .tab { display: inline-block; margin-right: 15px; padding-bottom: 5px; font-weight: bold; color: #666; border-bottom: 2px solid transparent; text-decoration: none; }
        .tab.active { color: #d81b60; border-bottom: 2px solid #d81b60; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: center; font-size: 14px; }
        th { background: #f3e5f5; }
        .btn { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .btn-approve { background-color: #c5e1a5; }
        .btn-reject { background-color: #ef9a9a; }
        .btn-remove { background-color: #b0bec5; }
    </style>

<script>
    /**
     * checkAll(mainCheck)
     * - ë©”ì¸ ì²´í¬ë°•ìŠ¤ë¥¼ í´ë¦­í•˜ë©´, ë©¤ë²„ ì²´í¬ë°•ìŠ¤ ì „ì²´ë¥¼ mainCheck ìƒíƒœì™€ ì¼ì¹˜ì‹œí‚´
     * - mainCheck: ë©”ì¸ ì²´í¬ë°•ìŠ¤ (true = ì „ì²´ ì²´í¬, false = ì „ì²´ í•´ì œ)
     */
    function checkAll(mainCheck) {
        var checkboxes = document.querySelectorAll('.memberCheck');
        for (var i = 0; i < checkboxes.length; i++) {
            checkboxes[i].checked = mainCheck.checked;
        }
    }

    /**
     * memberAction(action)
     * - ë©¤ë²„ ìŠ¹ì¸, ê±°ì ˆ, íƒˆí‡´ ìš”ì²­ì„ ë³´ë‚¼ ë•Œ ì‚¬ìš©
     * - ì„ íƒëœ ë©¤ë²„ë§ˆë‹¤ formì„ ë§Œë“¤ì–´ POST ì „ì†¡
     * - action: 'approve', 'reject', 'remove' ì¤‘ í•˜ë‚˜
     */
    function memberAction(action) {
        var checkboxes = document.querySelectorAll('.memberCheck');
        var selected = [];

        // ì„ íƒëœ ë©¤ë²„ë§Œ selected ë°°ì—´ì— ì¶”ê°€
        for (var i = 0; i < checkboxes.length; i++) {
            if (checkboxes[i].checked) {
                selected.push(checkboxes[i]);
            }
        }

        // ì•„ë¬´ê²ƒë„ ì„ íƒ ì•ˆ í–ˆìœ¼ë©´ ê²½ê³  í›„ ì¢…ë£Œ
        if (selected.length === 0) {
            alert('ì„ íƒëœ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // actionì— ë”°ë¼ ì‚¬ìš©ìì—ê²Œ í™•ì¸ ë©”ì‹œì§€ ì‘ì„±
        var msg = '';
        if (action === 'approve') {
            msg = 'ì„ íƒí•˜ì‹  íšŒì›ì˜ ê°€ì…ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì´ ' + selected.length + 'ëª…)';
        } else if (action === 'reject') {
            msg = 'ì„ íƒí•˜ì‹  íšŒì›ì˜ ê°€ì…ì„ ê±°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì´ ' + selected.length + 'ëª…)';
        } else if (action === 'remove') {
            msg = 'ì„ íƒí•˜ì‹  íšŒì›ì„ íƒˆí‡´ì‹œí‚¤ê² ìŠµë‹ˆê¹Œ?\n(ì´ ' + selected.length + 'ëª…)';
        }

        // ì‚¬ìš©ìì—ê²Œ í™•ì¸ì°½ (ì·¨ì†Œ ëˆ„ë¥´ë©´ ì¢…ë£Œ)
        if (!confirm(msg)) {
            return;
        }

        // í˜„ì¬ URL ê²½ë¡œì—ì„œ query string ì œê±° (ex: ?status=pending ê°™ì€ê±° ì œê±°)
        var basePath = location.pathname.split('?')[0]; 
        // ex: /community/1/member

        // ì„ íƒëœ ë©¤ë²„ë§ˆë‹¤ form ìƒì„± í›„ POST ì „ì†¡
        for (var j = 0; j < selected.length; j++) {
            var form = document.createElement('form');
            form.method = 'post';
            form.action = basePath + '/' + selected[j].value + '/' + action;
            // ex: /community/1/member/3/approve

            document.body.appendChild(form);

            // ë””ë²„ê·¸ìš©: ì „ì†¡ URL ì¶œë ¥
            console.log('ğŸ‘‰ form action = ' + form.action);

            form.submit();
        }
    }
</script>



</head>
<body>
<div layout:fragment="content">
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h4 th:text="${communityInfo.name} ?: 'ì»¤ë®¤ë‹ˆí‹°'">ì»¤ë®¤ë‹ˆí‹°</h4>
            <ul th:each="bdto : ${sidebarBoardList}">
                <li>
                    <a th:href="@{/community/{cId}/board/{boardId}(cId=${cId}, boardId=${bdto.id})}">[[${bdto.name}]]</a>
                </li>
            </ul>
            <a th:href="@{/community/{cId}/board/create(cId=${cId})}">+ ê²Œì‹œíŒ ì¶”ê°€</a>
        </div>

        <!-- Main -->
        <div class="main">
            <div class="tabs">
                <a class="tab" th:href="@{/community/{cId}/update(cId=${cId})}">ì •ë³´</a>
                <a class="tab" th:href="@{/community/{cId}/boardDelete(cId=${cId})}">ê²Œì‹œíŒ</a>
                <a class="tab active" th:href="@{/community/{cId}/member(cId=${cId})}">ë©¤ë²„</a>
                <a class="tab" th:href="@{/community/{cId}/close(cId=${cId})}">íì‡„</a>
            </div>

            <div>
                <label><input type="radio" name="status" th:checked="${status == 'active'}" onclick="location.href='?status=active'"> ê°€ì…ë©¤ë²„</label>
                <label><input type="radio" name="status" th:checked="${status == 'pending'}" onclick="location.href='?status=pending'"> ê°€ì… ìŠ¹ì¸ ëŒ€ê¸°</label>
            </div>

            <div>
                <button th:if="${status == 'active'}" class="btn btn-remove" onclick="memberAction('remove')">íƒˆí‡´</button>
                <div th:if="${status == 'pending'}">
                    <button class="btn btn-approve" onclick="memberAction('approve')">ìŠ¹ì¸</button>
                    <button class="btn btn-reject" onclick="memberAction('reject')">ê±°ì ˆ</button>
                </div>
            </div>

            <table>
                <thead>
                <tr>
                    <th><input type="checkbox" onclick="checkAll(this)"></th>
                    <th>ì´ë¦„</th>
                    <th>ì´ë©”ì¼</th>
                    <th>ë¶€ì„œ</th>
                    <th>ê°€ì…ì¼</th>
                    <th>ì—­í• </th>
                    <th>ê²Œì‹œê¸€ ìˆ˜</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="m : ${members}">
                    <td>
                        <input type="checkbox" class="memberCheck" th:if="${m['ROLE'] != 'master'}" th:value="${m['ID']}">
                        <span th:if="${m['ROLE'] == 'master'}">ğŸ‘‘</span>
                    </td>
                    <td th:text="${m['NAME']} ?: 'N/A'">N/A</td>
                    <td th:text="${m['EMAIL']} ?: 'N/A'">N/A</td>
                    <td th:text="${m['DEPT_NAME']} ?: 'N/A'">N/A</td>
                    <td th:text="${#dates.format(m['JOIN_DATE'], 'yyyy-MM-dd')} ?: 'N/A'">N/A</td>
                    <td th:text="${m['ROLE']} ?: 'N/A'">N/A</td>
                    <td th:text="${m['POST_COUNT'] ?: 0}">0</td>
                </tr>
                <tr th:if="${#lists.isEmpty(members)}">
                    <td colspan="7">ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
</body>
</html>
