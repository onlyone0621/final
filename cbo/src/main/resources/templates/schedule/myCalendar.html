<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
				xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
				layout:decorate="layouts/mainLayout">
<head>
<meta charset="UTF-8">

<title>캘린더</title>
<style>
a {
  text-decoration: none;
}
.fc-col-header-cell-cushion, .fc-daygrid-day-number {
    text-decoration: none;
}

.fc-scrollgrid-sync-inner > .fc-col-header-cell-cushion,
.fc-day-mon .fc-daygrid-day-number,
.fc-day-tue .fc-daygrid-day-number,
.fc-day-wed .fc-daygrid-day-number,
.fc-day-thu .fc-daygrid-day-number,
.fc-day-fri .fc-daygrid-day-number {
    color: black;
}

.fc-day-sun .fc-col-header-cell-cushion,
.fc-day-sun a{
    color : red;
}

.fc-day-sat .fc-col-header-cell-cushion,
.fc-day-sat a {
    color : blue;
}

.fc .fc-button, .fc .fc-button-primary {
    background-color: #ffc0b8 !important;   /* 메인색1 */
    color: #fff !important;
    border: none !important;
    border-radius: 20px !important;         /* 동글동글하게 */
   	padding: 4px 12px !important;      /* 기존 8px 20px에서 더 작게 */
    font-size: 0.95rem !important; 
    font-weight: bold;
    box-shadow: none !important;
    transition: background 0.2s;
    min-width: 0 !important;
}

.calendar-header {
  padding: 16px 0 8px 0;
  border-bottom: 2px solid #ffe6de; /* 은은한 메인 라인 */
  text-align: left;
  background: none;
}

.calendar-header h3 {
  color: #ff8a65; /* 메인 계열의 코랄 오렌지 */
  font-size: 1.5rem;
  font-weight: 600;
  margin: 0;
  letter-spacing: 0.5px;
  font-family: 'Segoe UI', 'Apple SD Gothic Neo', Arial, sans-serif;
  
  /* 사이드바 메뉴 간격 조정 */
.sidebar .list-group {
    margin-top: 0;
}

.sidebar .list-group-item {
    margin-bottom: 15px; /* 항목 간 아래쪽 간격 */
    border: none;
    background: transparent;
    padding: 0;
}

/* 개인캘린더, 부서캘린더 메뉴에 호버 효과 적용 */
.sidebar .list-group-item a {
    position: relative;
    display: block;
    color: #333;
    text-decoration: none;
    padding: 12px 18px;
    border-radius: 6px;
    transition: color 0.3s;
    z-index: 1;
}

.sidebar .list-group-item a::before {
    content: "";
    position: absolute;
    width: 100%;
    height: 100%;
    bottom: 0;
    left: 0;
    background-color: #ffc0b8; /* 메인색1과 어울리는 연한 핑크 */
    z-index: -1;
    border-radius: 6px;
    transform: scale(0);
    transition: transform 0.3s;
}

.sidebar .list-group-item a:hover::before,
.sidebar .list-group-item a:focus::before {
    transform: scale(1);
}

.sidebar .list-group-item a:hover,
.sidebar .list-group-item a:focus {
    color: #fff;
}
  
}

</style>
<script
	src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/index.global.min.js'></script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
function deleteWork(){
	const form = document.getElementById('editEventForm');
	const formData = new FormData(form);

	fetch('/api/calendar/deleteWork',
			{
				method:'POST',
				body:formData 
			})
			.then (res => res.json())
			.then (result =>{
			
				if(result>0){
					  var eventModalEl = document.getElementById('eventModal');
			            var modalInstance = bootstrap.Modal.getInstance(eventModalEl);
			            if (!modalInstance) {
			                modalInstance = new bootstrap.Modal(eventModalEl);
			            }
			            modalInstance.hide();
			            
						window.refreshCalendar();
						
					}
			});
	}
	
function updateWork(){
	const form = document.getElementById('editEventForm');
	const formData = new FormData(form);

	fetch('/api/calendar/updateWork',
			{
				method:'POST',
				body:formData
			})
			.then (res => res.json())
			.then (result =>{
			
				if(result>0){
					  var eventModalEl = document.getElementById('eventModal');
			            var modalInstance = bootstrap.Modal.getInstance(eventModalEl);
			            if (!modalInstance) {
			                modalInstance = new bootstrap.Modal(eventModalEl);
			            }
			            modalInstance.hide();
			            
						window.refreshCalendar();
						
					}
			});
	}
	
function insertWork() {
    const isAllDay = document.getElementById('allDay').checked;
    const form = document.getElementById('editEventForm');
    const formData = new FormData(form);

    if (isAllDay) {
        // 종일: date만
        const start = document.getElementById('start_time').value;
        const end = document.getElementById('end_time').value;
        formData.set('start_time', start);
        formData.set('end_time', end);
        formData.set('allday', 1);
    } else {
        // 시간: date + time 조합
        const startDate = document.getElementById('start_time_date').value;
        const startTime = document.getElementById('start_time_time').value;
        const endDate = document.getElementById('end_time_date').value;
        const endTime = document.getElementById('end_time_time').value;
        const start = startDate + 'T' + startTime + ':00';
        const end = endDate + 'T' + endTime + ':00';
        formData.set('start_time', start);
        formData.set('end_time', end);
        formData.set('allday', 0);
    }

    fetch('/api/calendar/add', {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(result => {
        if(result.success) {
            var eventModalEl = document.getElementById('eventModal');
            var modalInstance = bootstrap.Modal.getInstance(eventModalEl);
            if (!modalInstance) {
                modalInstance = new bootstrap.Modal(eventModalEl);
            }
            modalInstance.hide();
            window.refreshCalendar();
        }
    });
}



function saveWork(event){

	const formData = new FormData(event);
	 
	fetch("/api/calendar/saveWork",
			{method:'POST',
			body: formData	
			})
			.then(res => res.json())
			.then(result => {
				if(result>0){
					alert("성공");
				}else{
					alert("실패");
				}
			});
}


function checking() {
    var checked = document.getElementById('allDay').checked;
    
    if (checked) {
        document.getElementById('start_time').style.display = '';
        document.getElementById('end_time').style.display = '';
        document.getElementById('start_time_group').style.display = 'none';
        document.getElementById('end_time_group').style.display = 'none';
    } else {
        document.getElementById('start_time').style.display = 'none';
        document.getElementById('end_time').style.display = 'none';
        document.getElementById('start_time_group').style.display = '';
        document.getElementById('end_time_group').style.display = '';
    }
}




</script>
<script>
let calendar;


function refreshCalendar() {
    if(calendar) {
        calendar.refetchEvents(); // 서버에서 최신 일정 다시 불러오기
        calendar.render();
    }
}

	document.addEventListener('DOMContentLoaded', function() {

		let calendarEl = document.getElementById('calendar');
		
		 calendar = new FullCalendar.Calendar(calendarEl, {
			 
			  

			initialView : 'dayGridMonth', //달력 양식
			selectable : true, //날짜 칸 선택 가능 여부
			height : 600, //높이 설정
			locale : 'ko', //언어 지정
			editable : true, //이벤트 수정 가능 여부
			dayMaxEventRows : true, // 이벤트 최대 갯수 설정 및 팝오버 띄우기
			aspectRatio:2.5, //종횡비
			views : {
				timeGrid : {
					dayMaxEventRows : 3 //하루 최대 이벤트 갯수
				
				}
			},
			
			customButtons: {
				  myCustomButton: {
				    text: '저장',
				    click: function() {
				      const events = calendar.getEvents().map(ev => ({
				        id: ev.id,
				        start_time: ev.startStr,
				        end_time: ev.endStr
				      }));
				      console.log(events);
				      fetch("/api/calendar/saveWork", {
				        method: 'POST',
				        headers: {
				          'Content-Type': 'application/json'
				        },
				        body: JSON.stringify(events)
				      })
				      .then(res => res.json())
				      .then(result => {
				      });
				    }
				  }
				},
			
			
			headerToolbar: {
				  left: 'prev,next today',
				  center: 'title',
				  right: 'myCustomButton dayGridMonth,timeGridWeek,timeGridDay'
				},
				buttonText: {
					  today: '오늘',
					  month: '월간',
					  week: '주간',
					  day: '일간'
					},
			
			// initialView: 'listMonth',// 일정 목록 
			 dateClick: function(info) {
    			//window.open('calendarWorkReg?start_date=' + info.dateStr,'popup','width=500 height=500');
			 },
			 select: function(info) {
				    // 날짜만 (input type="date") - 반드시 yyyy-MM-dd 형식만!
				    document.getElementById('start_time').value = info.startStr.slice(0, 10);
				    document.getElementById('end_time').value = info.endStr ? info.endStr.slice(0, 10) : "";

				    // 시간 이벤트용 (date + time)
				    document.getElementById('start_time_date').value = info.startStr.slice(0, 10);
				    document.getElementById('start_time_time').value = info.startStr.length > 10 ? info.startStr.slice(11, 16) : "00:00";
				    document.getElementById('end_time_date').value = info.endStr ? info.endStr.slice(0, 10) : "";
				    document.getElementById('end_time_time').value = info.endStr && info.endStr.length > 10 ? info.endStr.slice(11, 16) : "00:00";

				    // 모달 관련 label, 버튼 초기화
				    var label1 = document.getElementById("eventModalLabel1");
				    var label2 = document.getElementById("eventModalLabel2");
				    var btn1 = document.getElementById("edit_btn1");
				    var btn2 = document.getElementById("edit_btn2");
				    var btn3 = document.getElementById("edit_btn3");

				    btn1.style.display = "none";
				    btn2.style.display = "none";
				    btn3.style.display = "none";
				    label1.style.display = "none";
				    label2.style.display = "none";

				    // 날짜 범위 계산 (종일 이벤트 등)
				   let endDate = new Date(info.endStr);
				    endDate.setDate(endDate.getDate() - 1);
				    let yyyy = endDate.getFullYear();
				    let mm = String(endDate.getMonth() + 1).padStart(2, '0');
				    let dd = String(endDate.getDate()).padStart(2, '0');
				    let endStr = `${yyyy}-${mm}-${dd}`;

				    // 모달 오픈 및 값 초기화
				    var myModal = new bootstrap.Modal(document.getElementById('eventModal'));
				    myModal.show();

				    document.getElementById("title").value = '';
				    document.getElementById("content").value = '';
				    document.getElementById("start_time").value = info.startStr.slice(0, 10);
				    document.getElementById("start_time_date").value = info.startStr.slice(0, 10);
				    document.getElementById("end_time").value = endStr;
				    document.getElementById("end_time_date").value = endStr;

				    btn3.style.display = "block";
				    label2.style.display = "block";
				},

				eventClick: function(info) {
				    var label1 = document.getElementById("eventModalLabel1");
				    var label2 = document.getElementById("eventModalLabel2");
				    var btn1 = document.getElementById("edit_btn1");
				    var btn2 = document.getElementById("edit_btn2");
				    var btn3 = document.getElementById("edit_btn3");

				    btn1.style.display = "none";
				    btn2.style.display = "none";
				    btn3.style.display = "none";
				    label1.style.display = "none";
				    label2.style.display = "none";

				    const event = info.event;

				    // 날짜 변환
				    function toDateString(dateObj) {
				        if (!dateObj) return "";
				        const d = typeof dateObj === "string" ? new Date(dateObj) : dateObj;
				        return d.toISOString().slice(0, 10);
				    }
				    function toTimeString(dateObj) {
				        if (!dateObj) return "";
				        const d = typeof dateObj === "string" ? new Date(dateObj) : dateObj;
				        return d.toTimeString().slice(0, 5);
				    }

				    var myModal = new bootstrap.Modal(document.getElementById('eventModal'));
				    myModal.show();

				    document.getElementById("id").value = event.id ?? '';
				    document.getElementById("title").value = event.title ?? '';
				    document.getElementById("content").value = event.extendedProps?.content ?? '';

				    // 종일 이벤트 여부 판단
				    var isAllDay = event.allDay || event.extendedProps?.allday == 1;

				    document.getElementById('allDay').checked = isAllDay;
				    checking(); // 종일/시간 input 토글

				    if (isAllDay) {
				        // 종일 이벤트: 종료일에서 하루 빼서 표시
				        let startDate = new Date(event.start);
				    	startDate.setDate(startDate.getDate()+1);
				        document.getElementById("start_time").value = startDate.toISOString().slice(0, 10);
			            document.getElementById("end_time").value = startDate.toISOString().slice(0, 10);
				        if (event.end) {
				            let endDate = new Date(event.end);
				            endDate.setDate(endDate.getDate());
				            document.getElementById("end_time").value = endDate.toISOString().slice(0, 10);
				        } else {
				        }
				    } else {
				        // 시간 이벤트
				        document.getElementById("start_time_date").value = toDateString(event.start);
				        document.getElementById("start_time_time").value = toTimeString(event.start);
				        document.getElementById("end_time_date").value = event.end ? toDateString(event.end) : toDateString(event.start);
				        document.getElementById("end_time_time").value = event.end ? toTimeString(event.end) : toTimeString(event.start);
				    }

				    btn1.style.display = "block"; // 수정
				    btn2.style.display = "block"; // 삭제
				    label1.style.display = "block"; // "일정 수정"
				},
			    events: '/api/calendar/events'


			    	
		});
		 
		calendar.render();
		
	});
	
	
	function checking() {
	    var checked = document.getElementById('allDay').checked;
	    document.getElementById('allDayInputs').style.display = checked ? '' : 'none';
	    document.getElementById('timeInputs').style.display = checked ? 'none' : '';
	}
	
	//등록
	function registerByType() {
	    const isAllDay = document.getElementById('allDay').checked;
	    if (isAllDay) {
	        registerAllDay();
	    } else {
	        registerTime();
	    }
	}

	// 종일 이벤트 등록 함수
	function registerAllDay() {
	    const formData = new FormData();
	    formData.append("title", document.getElementById('title').value);
	    formData.append("content", document.getElementById('content').value);
	    formData.append("start_date", document.getElementById('start_time').value);
	    formData.append("end_date", document.getElementById('end_time').value);
	    formData.append("allday", 1);

	    fetch("/api/calendar/addAllDay", {
	        method: "POST",
	        body: formData
	    })
	    .then(res => res.json())
	    .then(result => {
	        if(result.success) {
	            alert("종일 등록 성공!");
	            window.refreshCalendar();
	            bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
	        } else {
	            alert("등록 실패!");
	        }
	    });
	}

	function registerTime() {
	    const startDate = document.getElementById('start_time_date').value;
	    const startTime = document.getElementById('start_time_time').value;
	    const endDate = document.getElementById('end_time_date').value;
	    const endTime = document.getElementById('end_time_time').value;

	    // 타임존 없는 ISO 문자열로 조합
	    const start = `${startDate}T${startTime}:00`; // ex: "2025-07-15T10:00:00"
	    const end = `${endDate}T${endTime}:00`;

	    const formData = new FormData();
	    formData.append("title", document.getElementById('title').value);
	    formData.append("content", document.getElementById('content').value);
	    formData.append("start_time", start); // 타임존 없는 문자열
	    formData.append("end_time", end);
	    formData.append("allday", 0);

	    fetch("/api/calendar/addTime", {
	        method: "POST",
	        body: formData
	    })
	    .then(res => res.json())
	    .then(result => {
	        if(result.success) {
	            alert("시간 등록 성공!");
	            window.refreshCalendar();
	            bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
	        } else {
	            alert("등록 실패!");
	        }
	    });
	}

</script>

</head>
<body>
<div layout:fragment="content">
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
   <div class="modal-dialog">
      <div class="modal-content">
         <div class="modal-header">
            <h5 class="modal-title" id="eventModalLabel1" style="display: none">일정 수정</h5>
            <h5 class="modal-title" id="eventModalLabel2" style="display: none">일정 등록</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
         </div>
         <div class="modal-body">
            <form id="editEventForm">
               <div class="form-group">
                  <input type="hidden" class="form-control" name="id" id="id" >
               </div>
               <div class="form-group">
                  <label for="firstPlan">일정 제목</label>
                  <input type="text" class="form-control" name="title" id="title">
               </div>
               <div class="form-group">
                  <label for="firstComment">일정 내용</label>
                  <input type="text" class="form-control"  name="content" id="content">
               </div>
               <div id="allDayInputs">
                <label for="start_time">시작일</label>
				  <input type="date" name="start_date" id="start_time" class="form-control">
				  <label for="end_time">종료일</label>
				  <input type="date" name="end_date" id="end_time" class="form-control">
				</div>
				<!-- 시간 이벤트용 -->
				<div id="timeInputs" style="display:none">
				<label for="start_time_date">시작일</label><br>
				  <input type="date" id="start_time_date" class="form-control" style="width:60%;display:inline-block">
				  <input type="time" id="start_time_time" class="form-control" style="width:38%;display:inline-block">
				  <label for="end_time_date">종료일</label><br>
				  <input type="date" id="end_time_date" class="form-control" style="width:60%;display:inline-block">
				  <input type="time" id="end_time_time" class="form-control" style="width:38%;display:inline-block">
				</div>

               <div class="modal-footer">               
                   종일<input type="checkbox" class="btn btn-primary" id="allDay" onchange="checking(this);" checked>
                  <button type="button" class="btn btn-primary" id="edit_btn1" onclick = "updateWork()" style="display: none">수정</button>
                  <button type="button" class="btn btn-primary" id="edit_btn2" onclick = "deleteWork()" style="display: none">삭제</button>
                  <button type="button" class="btn btn-primary" id="edit_btn3" onclick = "registerByType()" style="display: none">등록</button>
               </div>
            </form>
         </div>
      </div>
   </div>
</div>


<div class="container-fluid">
  <div class="row">
<nav class="col-md-2 d-none d-md-block bg-light sidebar" style="min-height:100vh;">
  <div class="sidebar-sticky pt-4">
    <h4 style="margin-bottom: 40px;">일정관리</h4>
    <ul class="list-group">


    </ul>
  </div>
</nav>
    <main class="col-md-10 ml-sm-auto px-4">
      <div class="calendar-header">
        <h3>일정관리</h3>
      </div>
      <div id="calendar"></div>
    </main>
  </div>
</div>
</div>
</body>
</html>