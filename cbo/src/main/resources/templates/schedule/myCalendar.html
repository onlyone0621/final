<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
				xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
				layout:decorate="layouts/mainLayout">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>캘린더</title>
<style>
.fc-col-header-cell-cushion, .fc-daygrid-day-number {
    text-decoration: none;
}

.fc-scrollgrid-sync-inner > .fc-col-header-cell-cushion,
.fc-day-mon .fc-daygrid-day-number,
.fc-day-tue .fc-daygrid-day-number,
.fc-day-wed .fc-daygrid-day-number,
.fc-day-thu .fc-daygrid-day-number,
.fc-day-fri .fc-daygrid-day-number {
    color: black;
}

.fc-day-sun .fc-col-header-cell-cushion,
.fc-day-sun a{
    color : red;
}

.fc-day-sat .fc-col-header-cell-cushion,
.fc-day-sat a {
    color : blue;
}

</style>



<script
	src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/index.global.min.js'></script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
function deleteWork(){
	const form = document.getElementById('editEventForm');
	const formData = new FormData(form);

	fetch('/api/calendar/deleteWork',
			{
				method:'POST',
				body:formData
			})
			.then (res => res.json())
			.then (result =>{
			
				if(result>0){
						window.refreshCalendar();
						
					}
			});
	}
</script>
<script>
let calendar;

function refreshCalendar() {
    if(calendar) {
        calendar.refetchEvents(); // 서버에서 최신 일정 다시 불러오기
        calendar.render();
    }
}

	document.addEventListener('DOMContentLoaded', function() {

		let calendarEl = document.getElementById('calendar');
		
		 calendar = new FullCalendar.Calendar(calendarEl, {

			 

			initialView : 'dayGridMonth', //달력 양식
			selectable : true, //날짜 칸 선택 가능 여부
			height : 850, //높이 설정
			locale : 'ko', //언어 지정
			editable : true, //이벤트 수정 가능 여부
			dayMaxEventRows : true, // 이벤트 최대 갯수 설정 및 팝오버 띄우기
			views : {
				timeGrid : {
					dayMaxEventRows : 3 //하루 최대 이벤트 갯수
				
				}
			},
			
			customButtons: {
				  myCustomButton: {
				    text: '저장',
				    click: function() {
				      alert('커스텀 버튼 클릭!');
				      // 원하는 기능 추가
				    }
				  }
				},
			
			headerToolbar: {
				  left: 'prev,next today',
				  center: 'title',
				  right: 'myCustomButton dayGridMonth,timeGridWeek,timeGridDay'
				},
				buttonText: {
					  today: '오늘',
					  month: '월간',
					  week: '주간',
					  day: '일간'
					},
			
			// initialView: 'listMonth',// 일정 목록 
			 dateClick: function(info) {
    			//window.open('calendarWorkReg?start_date=' + info.dateStr,'popup','width=500 height=500');
			 },
			 select: function(info) {
				    var endStr = info.endStr;
				    
				    let date = new Date(endStr);
				    date.setDate(date.getDate() - 1);
				   
				    let yyyy = date.getFullYear();
				    let mm = String(date.getMonth() + 1).padStart(2, '0');
				    let dd = String(date.getDate()).padStart(2, '0');
				    
				    endStr = `${yyyy}-${mm}-${dd}`;
				   
				  //  alert('selected ' + info.startStr + ' to ' + endStr);

				    
				    window.open('calendarWorkReg?start_date=' + info.startStr + '&end_date=' + endStr, 'createPopup', 'width=500,height=500');
				    },
			    eventClick: function(info) { //이벤트 클릭시

			    	const event = info.event;

			    	 var endStr = event.endStr;
					    let date = new Date(endStr);
					    date.setDate(date.getDate() - 1);
					    let yyyy = date.getFullYear();
					    let mm = String(date.getMonth() + 1).padStart(2, '0');
					    let dd = String(date.getDate()).padStart(2, '0');
					    endStr = `${yyyy}-${mm}-${dd}`;
					    
					    var myModal = new bootstrap.Modal(document.getElementById('eventModal'));
				        myModal.show();
					    
				        document.getElementById("id").value = event.id;
				        document.getElementById("title").value = event.title;
				        document.getElementById("content").value = event.extendedProps.content;
				        document.getElementById("start_date").value = event.startStr;
				        document.getElementById("end_date").value = endStr;
				        
				        
				        console.log(event.title);
			        //alert('start: ' + info.event.startStr + 'end : '+ endStr );
			    	//window.open('calendarOptionView?start_date='+info.event.startStr+'&end_date='+endStr+'&title='+info.event.title+'&content='+info.event.extendedProps.content+'&id='+info.event.id, 'optionPopup','width=500,height=500');
			    },	
			    events: '/api/calendar/events'
		            
			    	
		});
		calendar.render();
		 
	});
	
	
</script>

</head>
<body>
<div layout:fragment="content">
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
   <div class="modal-dialog">
      <div class="modal-content">
         <div class="modal-header">
            <h5 class="modal-title" id="eventModalLabel">일정 수정</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
         </div>
         <div class="modal-body">
            <form id="editEventForm">
               <input type="hidden" id="planNo" name="planNo">
               <div class="form-group">
                  <input type="hidden" class="form-control" name="id" id="id">
               </div>
               <div class="form-group">
                  <label for="firstPlan">일정 제목</label>
                  <input type="text" class="form-control" name="title" id="title">
               </div>
               <div class="form-group">
                  <label for="firstComment">일정 내용</label>
                  <input type="text" class="form-control"  name="content" id="content">
               </div>
               <div class="form-group">
                 <label for="start_date" class="form-label">시작일</label>
                 <input type="date" name="start_date"  id="start_date" class="form-control" th:value = "${start_date}">
               </div>
               <div>
                  <label for="end_date" class="form-label">종료일</label>
                  <input type="date" name="end_date"  id="end_date" class="form-control">
               </div>
               <div class="modal-footer">
                  <button type="button" class="btn btn-primary" id="edit_btn">수정</button>
                  <button type="button" class="btn btn-primary" id="edit_btn" onclick = "deleteWork()">삭제</button>
               </div>
            </form>
         </div>
      </div>
   </div>
</div>
	<div id='calendar'></div>
	</div>
</body>
</html>