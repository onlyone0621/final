<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
				xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
				layout:decorate="layouts/mainLayout">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>내 정보 수정하기</title>
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: white;
        margin: 0;
        padding: 0;
    }

    form {
        margin: 0px auto;
        padding: 30px;
        background-color: white;
    }

    input::placeholder,
    textarea::placeholder {
    	font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: #999;
    }	
    
	.menu-title{
		text-align: center;
		font-size: 22px;
		font-weight: bold;
	}
	
	.main-div{
		display: flex;
	}
	
	.chat-div{
		margin-left: 20px;
		text-align: center;
		display: flex;
		width: 800px
	}
	
	.title{
		margin-top: 50px;
		font-size: 30px;
		margin-left: 30px;
		font-weight: bold;
	}
	.title hr{
		border: solid 1.5px;
		width: 1850px;
	}

    .chat-container {
        flex: 1;
        display: flex;
        gap: 150px;
        height: 100%;
    }

    .chat-room-list {
        width: 300px;
        height: 100%;
        background-color: #f9f9f9;
        padding: 20px;
        border-radius: 12px;
        box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
        overflow-y: auto;
    }

    .chat-room-list h3 {
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 18px;
    }

    .chat-room-item {
    	height: 80px;
        padding: 10px 12px;
        margin-bottom: 10px;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s, box-shadow 0.2s;
    }

    .chat-room-item:hover {
        background-color: #e8f0ff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .chat-window {
    	width: 800px;
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: #f9f9f9;
        border-radius: 12px;
        box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
        padding: 15px;
        box-sizing: border-box;
    }

    .chat-messages {
        flex: 1;
        border: 1px solid #eee;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 8px;
        background-color: #ffffff;
        text-align: left;
    }

    .chat-input {
        display: flex;
        gap: 10px;
    }

    #chat-input {
        flex: 1;
        padding: 10px 14px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 14px;
    }

    #sendBtn {
        padding: 10px 20px;
        border: none;
        background-color: #FFC6C6;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
    }

    #sendBtn:hover {
        background-color: #FFA2A2;;
    }

    @media (max-width: 768px) {
        .chat-container {
            flex-direction: column;
        }

        .chat-room-list,
        .chat-window {
            width: 100%;
        }
    }
	.chat-messages p {
  		margin: 0;
	}
	
	#createBtn{
		padding: 10px 20px;
        border: none;
        background-color: #FFC6C6;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
	}
	
	#createBtn:hover {
        background-color: #FFA2A2;;
    }
	.modal {
		display: none; /* 기본은 숨김 */
		position: fixed;
		top: 0; left: 0; right: 0; bottom: 0;
		background-color: rgba(0,0,0,0.5);
		z-index: 999;
	}
	
	.modal-content {
		background: white;
		padding: 20px;
		width: 400px;
		margin: 10% auto;
		border-radius: 8px;
		box-shadow: 0 2px 10px rgba(0,0,0,0.2);
	}
	
	.modal-content input,
	.modal-content textarea {
		font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
		width: 100%;
		margin-bottom: 12px;
		flex: 1;
	    padding: 10px 14px;
	    border: 1px solid #ccc;
	    border-radius: 8px;
	    font-size: 14px;
	}
	
	.modal-actions {
		text-align: right;
	}
	
	.modal-actions button {
		padding: 6px 12px;
		margin-left: 5px;
		border: none;
		border-radius: 4px;
		cursor: pointer;
	}
	
	.modal-actions button {
		background-color: #FFC6C6;
		color: white;
	}   
	
	.modal-actions button:hover {
        background-color: #FFA2A2;;
    }
	.chat-header {
    	display: flex;
    	justify-content: center; 
    	align-items: center;
    	position: relative;      
    	margin-bottom: 10px;
  	}
  	#chatRoomTitle {
    	margin: 0 auto;         
  	}
  	.menu-container {
		position: absolute;
    	right: 0;               
    	top: 50%;
    	transform: translateY(-50%);
	}
	
  	.menu-icon {
    	font-size: 18px;
    	cursor: pointer;
    	padding: 4px 8px;
    	user-select: none;
  	}

  	.dropdown-menu {
    	position: absolute;
    	top: 24px;
    	right: 0;
    	background-color: white;
    	border: 1px solid #ccc;
    	min-width: 120px;
    	box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    	z-index: 100;
    	display: none;
  	}

  	.dropdown-menu a {
    	display: block;
    	padding: 8px 12px;
    	text-decoration: none;
    	color: #333;
    	font-size: 14px;
  	}

  	.dropdown-menu a:hover {
    	background-color: #f0f0f0;
  	}
  	
	#chatList {
		padding: 10px;
		max-height: 400px;
		overflow-y: auto;
		border: 1px solid #ccc;
		font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
	}

	.date-divider {
		text-align: center;
		margin: 10px 0;
		font-weight: bold;
		color: #5D5D5D;
		font-size: 16px;
		clear: both;
	}

	/* 말풍선 공통 스타일 */
	.msg-bubble {
	  	max-width: 70%;
	  	margin: 15px 0;
	  	padding: 10px 15px;
	  	border-radius: 15px;
	  	position: relative;
	  	font-size: 14px;
	  	line-height: 1.3;
	  	word-wrap: break-word;
	  	clear: both;
	}
	
	/* 상대방 메시지 (왼쪽 정렬, 연한 회색 배경) */
	.msg-bubble.left {
	  	background-color: #f1f0f0;
	  	color: #000;
	  	float: left;
	}
	
	/* 말풍선 꼬리 (왼쪽) */
	.msg-bubble.left::before {
	  	content: "";
	  	position: absolute;
	  	top: 10px;
	  	left: -7px;
	  	width: 0;
	  	height: 0;
	  	border-top: 8px solid transparent;
	  	border-right: 8px solid #f1f0f0;
	  	border-bottom: 8px solid transparent;
	}
	
	/* 내 메시지 (오른쪽 정렬, 파란색 배경, 흰색 글씨) */
	.msg-bubble.right {
	  	background-color: #FAF4C0;
	  	color: #000;
	  	float: right;
	}
	
	/* 말풍선 꼬리 (오른쪽) */
	.msg-bubble.right::before {
	  	content: "";
	  	position: absolute;
	  	top: 10px;
	  	right: -7px;
	  	width: 0;
	  	height: 0;
	  	border-top: 8px solid transparent;
	  	border-left: 8px solid #FAF4C0;
	  	border-bottom: 8px solid transparent;
	}
	.msg-header {
		display: flex;
  		justify-content: space-between;
  		align-items: baseline;
  		margin-bottom: 5px;
	}

	.msg-name {
		font-weight: bold;
		font-size: 16px; /* 크게 */
  		color: #5A5A5A;
	}

	.msg-time {
  		font-size: 12px; /* 작게 */
  		color: #888;
  		margin-left: 10px;
	}

	.msg-content {
  		font-size: 14px; /* 평범하게 */
  		margin: 0;
  		white-space: pre-wrap; /* 줄바꿈 보존 */
  		color: #5A5A5A;
	}
</style>
<script>
window.onload = function () {
    scrollToBottom();
};

function scrollToBottom() {
    const chatBox = document.getElementById("chatList");
    chatBox.scrollTop = chatBox.scrollHeight;
}

document.addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
        const active = document.activeElement;
        if (active && active.id === "chat-input") {
            event.preventDefault(); // 혹시라도 form 제출 방지
            document.getElementById("sendBtn").click();
        }
    }
});

var ws;
var con=false;
var sw=false;
function conn(roomId){
	ws = new WebSocket("ws://192.168.0.141:9090/ws/chat?room_id="+roomId);
	ws.onmessage = onMsg;	
}

function onMsg(evt) {
    const data = evt.data;
    
    const [user, ...msgParts] = data.split(':');
    const msgContent = msgParts.join(':').trim();

    const myName = document.getElementById("user").value;
    
    if (user.trim() === myName.trim()) {
        addMyMessageToChatList(user, msgContent);
    } else {
        addOtherMessageToChatList(user, msgContent);
    }

    scrollToBottom();
    if (sw) {
        cl();
    }
}

function exit(){
	if(con == false){
		alert('채팅방을 이용중이지 않습니다.');
	}else{
		var user = document.getElementById("user").value;
		ws.send(user+'님이 퇴장하셨습니다.');
		sw=true;		
	}
}
function cl(){
	ws.close();
	con=false;
}
function sendMessage(){
	var user = document.getElementById("user").value;
	var msg = document.messenger.msg.value;
	if(msg == null || msg == ''){
		alert('메세지를 입력해주세요.');
		return;
	}
	if(user == null){
		alert('로그인 정보를 확인해주세요.');
		location.href="/";
		return;
	}
	ws.send(msg);
	document.messenger.msg.value="";
	document.messenger.msg.focus();
}

function addMyMessageToChatList(user, msgContent) {
    const chatContent = document.getElementById("chatList");
    const msgDiv = document.createElement("div");
    const now = new Date();

    // 시간 형식
    const timeStr = now.toLocaleTimeString('ko-KR', {
        hour: '2-digit',
        minute: '2-digit'
    });

    // 채팅 메시지 구성 (이름 + 시간 + 내용)
    const nameSpan = document.createElement("span");
    nameSpan.textContent = user;
    nameSpan.classList.add("msg-name");

    const timeSpan = document.createElement("span");
    timeSpan.textContent = timeStr;
    timeSpan.classList.add("msg-time");

    const contentP = document.createElement("p");
    contentP.textContent = msgContent;
    contentP.classList.add("msg-content");

    const headerDiv = document.createElement("div");
    headerDiv.classList.add("msg-header");
    headerDiv.appendChild(nameSpan);
    headerDiv.appendChild(timeSpan);

    msgDiv.classList.add("msg-bubble", "right"); // 내 메시지는 오른쪽
    msgDiv.appendChild(headerDiv);
    msgDiv.appendChild(contentP);

    chatContent.appendChild(msgDiv);
    scrollToBottom();
}

function addOtherMessageToChatList(user, msgContent) {
    const chatContent = document.getElementById("chatList");
    const msgDiv = document.createElement("div");
    const now = new Date();

    const timeStr = now.toLocaleTimeString('ko-KR', {
        hour: '2-digit',
        minute: '2-digit'
    });

    const nameSpan = document.createElement("span");
    nameSpan.textContent = user;
    nameSpan.classList.add("msg-name");

    const timeSpan = document.createElement("span");
    timeSpan.textContent = timeStr;
    timeSpan.classList.add("msg-time");

    const contentP = document.createElement("p");
    contentP.textContent = msgContent;
    contentP.classList.add("msg-content");

    const headerDiv = document.createElement("div");
    headerDiv.classList.add("msg-header");
    headerDiv.appendChild(nameSpan);
    headerDiv.appendChild(timeSpan);

    msgDiv.classList.add("msg-bubble", "left");
    msgDiv.appendChild(headerDiv);
    msgDiv.appendChild(contentP);

    chatContent.appendChild(msgDiv);
}

var XHR=null;
function getXHR(){
	if(window.ActioveXObject){
		return new ActiveXObject("Msxml2.XMLHTTP");
	}else if(window.XMLHttpRequest){
		return new XMLHttpRequest();
	}else{
		return null;
	}
}

function sendRequest(url,params,callback,method){
	XHR = getXHR();
	var newMethod = method ? method : 'GET';//1차 유효성 검사
	//2차 유효성 검사
	if(newMethod!='GET' && newMethod!='POST'){
		newMethod = 'GET';
	}
	//3차 유효성 검사
	var newParams = (params==null||params=='') ? null : params;
	if(newMethod=='GET' && newParams!=null){
		url = url + '?' + newParams;
	}
	XHR.onreadystatechange=callback;
	XHR.open(newMethod, url, true);
	XHR.setRequestHeader('Context-Type','application/x-www-form-urlencoded');
	XHR.send(newParams);
}

function chatRoom(element) {
	const id = element.getAttribute("data-room-id");
	const name = element.getAttribute("data-room-name");
	params = 'id='+id;
	sendRequest('chatContent',params,function() {
        chatContent(id);},'GET');
	document.getElementById("chatRoomTitle").textContent = name;
	
}

function chatContent(roomId){
	if(XHR.readyState==4){
		if(XHR.status==200){
			var chatContent = document.getElementById("chatList");
			chatContent.innerHTML = "";
			var data = JSON.parse(XHR.responseText);

			let lastDate = null;
			const myName = document.getElementById("user").value;  // 여기에 본인 이름 입력

			data.forEach(function (msg) {
				const raw = msg.write_date;
				const isoStr = raw.includes('T') ? raw : raw.replace(' ', 'T');
				const dateObj = new Date(isoStr);

				if (isNaN(dateObj.getTime())) {
					console.warn("날짜 파싱 실패:", raw);
					return;
				}

				const dateStr = dateObj.toLocaleDateString('ko-KR', {
					year: 'numeric',
					month: 'long',
					day: 'numeric',
					weekday: 'short'
				});

				const timeStr = dateObj.toLocaleTimeString('ko-KR', {
					hour: '2-digit',
					minute: '2-digit'
				});

				if (lastDate !== dateStr) {
					lastDate = dateStr;

					const dateDivider = document.createElement("div");
					dateDivider.textContent = `${dateStr}`;
					dateDivider.classList.add("date-divider");
					chatContent.appendChild(dateDivider);
				}

				const msgDiv = document.createElement("div");
				msgDiv.classList.add("msg-bubble");
				if(msg.name === myName) {
					msgDiv.classList.add("right");
				} else {
					msgDiv.classList.add("left");
				}

				const nameSpan = document.createElement("span");
				nameSpan.textContent = msg.name;
				nameSpan.classList.add("msg-name");

				const timeSpan = document.createElement("span");
				timeSpan.textContent = timeStr;
				timeSpan.classList.add("msg-time");

				const contentP = document.createElement("p");
				contentP.textContent = msg.content;
				contentP.classList.add("msg-content");

				const headerDiv = document.createElement("div");
				headerDiv.classList.add("msg-header");
				headerDiv.appendChild(nameSpan);
				headerDiv.appendChild(timeSpan);

				msgDiv.appendChild(headerDiv);
				msgDiv.appendChild(contentP);
				chatContent.appendChild(msgDiv);
				chatContent.appendChild(msgDiv);
			});

			scrollToBottom();
			conn(roomId);
		}
	}
}

function openCreateChatRoom() {
	document.getElementById("roomName").value = "";
	document.getElementById("roomDesc").value = "";
	document.getElementById("chatRoomModal").style.display = "block";
}

function closeModal() {
	document.getElementById("chatRoomModal").style.display = "none";
}

function createChatRoom() {
	const name = document.getElementById("roomName").value.trim();
	const desc = document.getElementById("roomDesc").value.trim();

	if (!name) {
		alert("채팅방 이름을 입력해주세요.");
		return;
	}else{
		params = 'name='+name+'&description='+desc;
		sendRequest('createChatRoom',params,resultCreateChatRoom,'GET');
	}
	closeModal();
}

function resultCreateChatRoom(){
	if(XHR.readyState==4){
		if(XHR.status==200){
			alert('채팅방이 생성되었습니다.');
			location.href="messengerMain";
		}else{
			alert('채팅방 생성에 실패했습니다.');
			return;
		}
	}
}
function toggleMenu() {
	const menu = document.getElementById("menuDropdown");
	menu.style.display = (menu.style.display === "block") ? "none" : "block";
}

  // 메뉴 외부 클릭 시 닫기
document.addEventListener("click", function(event) {
	const menu = document.getElementById("menuDropdown");
	const icon = document.querySelector(".menu-icon");
	if (!icon.contains(event.target) && !menu.contains(event.target)) {
		menu.style.display = "none";
	}
});

function invite() {
	alert("초대 기능 실행");
	// 여기에 초대 로직 추가
}

function leaveRoom() {
	if (confirm("채팅방에서 나가시겠습니까?")) {
		alert("방 나가기 실행");
		// 방 나가기 로직 추가
	}
}
</script>
</head>
<body>
<div layout:fragment="content">
	<div class="main-div">
        <div>
        	<div class="title">
        		<lable>메신저</lable>
        		<hr>
        	</div>
        	<div class="chat-div">
				<form name="messenger" action="messenger" method="post" onsubmit="return false;">
				    <input type="hidden" id="user" th:if="${session.udto != null}" th:value="${session.udto.name}" />
				    <input type="hidden" id="user" th:unless="${session.udto != null}" th:value="" />
				    <div class="chat-container">
				        <div class="chat-room-list">
							<h3>참여 중인 채팅방</h3>						
							<div th:each="room : ${chatList}" class="chat-room-item" th:text="${room.name}" th:attr="data-room-id=${room.id}, data-room-name=${room.name}" onclick="chatRoom(this)"></div>
							
							<div class="create-chat-room-wrapper">
						        <input type="button" id="createBtn" value="채팅방 생성" onclick="openCreateChatRoom()">
						    </div>
						    <div id="chatRoomModal" class="modal">
								<div class="modal-content">
							    	<h3>채팅방 생성</h3>
							    		<input type="text" id="roomName" placeholder="채팅방 이름">
							    		<textarea id="roomDesc" placeholder="방에 대한 간략 설명"></textarea>
							
							    	<div class="modal-actions">
							      		<button onclick="createChatRoom()">생성</button>
							      		<button onclick="closeModal()">취소</button>
							    	</div>
							  	</div>
							</div>
						</div>
				
				        <div class="chat-window">
							<div class="chat-header">
								<h3 id="chatRoomTitle">참여 중인 채팅방</h3>
								<div class="menu-container">
							    	<div class="menu-icon" onclick="toggleMenu()">︙</div>
							    		<div id="menuDropdown" class="dropdown-menu">
							    			<a href="#" onclick="invite()">초대하기</a>
							    			<a href="#" onclick="leaveRoom()">방 나가기</a>
										</div>
									</div>
							</div>
							
							<div id="chat-messages" class="chat-messages">
								<div id="chatList" th:text="${msgList}" style="white-space: pre-wrap; height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;"></div>
							</div>
							
							<div class="chat-input">
								<input type="text" id="chat-input" name="msg" placeholder="메시지를 입력하세요." onkeypress="if(event.key==='Enter') sendMessage()">
								<button type="button" id="sendBtn" onclick="sendMessage()">전송</button>
							</div>
				        </div>
				    </div>
				</form>
        	</div>
		</div>
	</div>
</div>
</body>
</html>